name: ðŸ”’ Token Data Validation

on:
  push:
    branches: [main, develop]
    paths:
      - 'contracts/**/*.json'
      - 'tokens/**/*.json'
  pull_request:
    branches: [main]
    paths:
      - 'contracts/**/*.json'
      - 'tokens/**/*.json'

jobs:
  validate-json:
    name: Validate Token Configuration
    runs-on: ubuntu-latest
    
    steps:
      - name: ðŸ“¥ Checkout Repository
        uses: actions/checkout@v4

      - name: ðŸ” Validate JSON Files
        id: validate
        run: |
          echo "## ðŸ”’ Token Data Validation Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          JSON_VALID=true

          for json_file in $(find contracts tokens -name "*.json" -type f 2>/dev/null || true); do
            echo "Validating: $json_file"

            # 1ï¸âƒ£ Basic JSON validity check
            if jq empty "$json_file" 2>/dev/null; then
              echo "âœ… Valid JSON: $json_file" >> $GITHUB_STEP_SUMMARY
            else
              echo "âŒ Invalid JSON: $json_file" >> $GITHUB_STEP_SUMMARY
              JSON_VALID=false
              continue
            fi

            # 2ï¸âƒ£ TWUSD decimals check â€” ONLY token-info.json
            if [[ "$json_file" == *"twusd"* && "$json_file" == *"token-info.json"* ]]; then
              decimals=$(jq -r '.decimals // empty' "$json_file")

              if [ -z "$decimals" ]; then
                echo "  âŒ TWUSD decimals missing" >> $GITHUB_STEP_SUMMARY
                JSON_VALID=false
              elif [ "$decimals" = "6" ]; then
                echo "  âœ… TWUSD decimals correct: $decimals" >> $GITHUB_STEP_SUMMARY
              else
                echo "  âŒ TWUSD decimals incorrect: $decimals (expected: 6)" >> $GITHUB_STEP_SUMMARY
                JSON_VALID=false
              fi
            fi
          done

          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "$JSON_VALID" = "false" ]; then
            echo "json_validation=failed" >> $GITHUB_OUTPUT
            echo "### âŒ Validation Failed" >> $GITHUB_STEP_SUMMARY
            exit 1
          else
            echo "json_validation=passed" >> $GITHUB_OUTPUT
            echo "### âœ… All Token Data Valid" >> $GITHUB_STEP_SUMMARY
          fi

      - name: ðŸŽ¯ Verify TWUSD Contract Address
        run: |
          echo "## ðŸŽ¯ Contract Address Verification" >> $GITHUB_STEP_SUMMARY
          
          EXPECTED_ADDRESS="0x7BeB51807E3c8BdB10A2868bD51c2D9E1764925D"
          ACTUAL_ADDRESS=$(jq -r '.contractAddress' tokens/twusd/token-info.json)
          
          if [ "$ACTUAL_ADDRESS" = "$EXPECTED_ADDRESS" ]; then
            echo "âœ… Contract address verified: $ACTUAL_ADDRESS" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ Contract address mismatch!" >> $GITHUB_STEP_SUMMARY
            echo "  Expected: $EXPECTED_ADDRESS" >> $GITHUB_STEP_SUMMARY
            echo "  Got: $ACTUAL_ADDRESS" >> $GITHUB_STEP_SUMMARY
            exit 1
          fi

      - name: ðŸ“Š Display Token Summary
        if: success()
        run: |
          echo "## ðŸ“Š TWUSD Token Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Property | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
          
          jq -r 'to_entries | map("| \(.key) | \(.value) |") | .[]' tokens/twusd/token-info.json >> $GITHUB_STEP_SUMMARY
